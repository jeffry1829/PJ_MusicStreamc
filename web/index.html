<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>PJ_musicStream</title>
	<link rel="stylesheet" href="lib/tocas.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="lib/config.js"></script>
	<script src="lib/shake.js"></script>
	<script>
		var now_song_id;
		var y_player;
		function onPlayerReady(){
			var myShakeEvent = new Shake();
			window.addEventListener('shake', function(){
				if(y_player){
				if(y_player.getPlayerState() !== 1 && y_player.getPlayerState() !== -1){
					y_player.playVideo();
				}
				}
			}, false);
			function y_url_add(){
				$.ajax({
					type: 'POST',
					url: domain+'/addYoutube',
					dataType: 'json',
					data: {
						url: $(this).val()
					},
					success: function(res){
						// res doesn't matter
						$('#y-url-input').val('')
						updateSongList();
					},
					error: function(xhr){
						console.log(xhr);
					}
				})
			}
			function updateSongList(){
				$('#s-list').empty();
				$.ajax({
					type: 'POST',
					url: domain+'/getList',
					dataType: 'json',
					success: function(res){
						var type_object = {};
						$.each(res, function(index, value){
							if(!type_object[value.s_type]){
								type_object[value.s_type] = {};
							}
							// s_id as key
							type_object[value.s_type][value.s_id] = value;
						});
						
						$.each(type_object, function(index, value){
							$('#s-list').append(' \
								<div class="ts massive header">'+index+'</div> \
							');
							// If type === Youtube, add remove button
							if(index === 'Youtube'){
								$.each(value, function(index, value){
									if(!value.removed){ // if not removed
										$('#s-list').append(' \
												<div class="item s-list-item"> \
													<div class="header">'+value.s_id+' '+value.s_name+'</div> \
													'+value.s_t+'sec \
													<button class="ts icon button mini compact negative youtube-item-remove"> \
														<i class="icon remove"></i> \
													</button> \
												</div> \
										');
									}
								});
							}else{
								$.each(value, function(index, value){
									$('#s-list').append(' \
											<div class="item s-list-item"> \
												<div class="header">'+value.s_id+' '+value.s_name+'</div> \
												'+value.s_t+'sec \
											</div> \
									');
								});
							}
						});
						$('.s-list-item').click(s_list_item_click);
						$('.youtube-item-remove').click(youtube_item_remove);
					},
					error: function(xhr){
						console.log(xhr);
					}
				});
			}
			function youtube_item_remove(e){
				e.stopPropagation(); // only for remove button
				$.ajax({
					type: 'POST',
					url: domain+'/removeYoutube',
					dataType: 'json',
					data: {
						youtube_s_id: Number($(this).parent()[0].innerText.split(' ')[0])
					},
					success: function(res){
						updateSongList();
					},
					error: function(xhr){
						console.log(xhr);
					}
				})
			}
			function s_list_item_click(){
				console.log('inner s-list-item clicked event => $(this)');
				console.log($(this))
				console.log('inner s-list-item clicked event => $(this).val()');
				console.log($(this).val())
				console.log('inner s-list-item clicked event => $(this)[0].innerText');
				console.log($(this)[0].innerText) //this is ok
				console.log('inner s-list-item clicked event => Number($(this)[0].innerText.split(\' \')[0])');
				console.log(Number($(this)[0].innerText.split(' ')[0]))
				
				$.ajax({
					type: 'POST',
					url: domain+'/addQueue',
					dataType: 'json',
					data: {
						s_id: Number($(this)[0].innerText.split(' ')[0]),
						start_time: -3 //There's no way to set yet
					},
					success: function(res){
						//doesn't matter
					},
					error: function(xhr){
						console.log(xhr);
					}
				});
				updateQueueList();
			}
			function updateQueueList(){
				$('#queue-list').empty();
				$.ajax({
					type: 'POST',
					url: domain+'/getQueue',
					dataType: 'json',
					success: function(res){
						res.forEach(function(value, index){
							$('#queue-list').append(' \
								<div class="item queue-item"> \
									'+index+' ('+value.s_id+' '+value.s_name+' '+value.s_t+'sec) \
									<button class="ts icon button mini compact negative queue-item-remove"> \
										<i class="icon remove"></i> \
									</button> \
								</div> \
								<br /> \
							');
						});
						$('.queue-item-remove').click(removeQueue);
						$('.queue-item').click(queue_forcePlay);
					},
					error: function(xhr){
						console.log(xhr);
					}
				});
			}
			function queue_forcePlay(){
				$.ajax({
					type: 'POST',
					url: domain+'/forcePlay',
					dataType: 'json',
					data: {
						queue_index: Number($(this)[0].innerText.split(' ')[0])
					},
					success: function(res){
						// doesn't matter
					},
					error: function(xhr){
						console.log(xhr);
					}
				});
				window.location.reload();
			}
			function removeQueue(e){
				e.stopPropagation(); // only for remove button
				$.ajax({
					type: 'POST',
					url: domain+'/removeQueue',
					dataType: 'json',
					data: {
						queue_index: Number($(this).parent()[0].innerText.split(' ')[0])
					},
					success: function(res){
						// doesn't matter
					},
					error: function(xhr){
						console.log(xhr);
					}
				});
				updateQueueList();
			}
			
			updateSongList();
			
			$.ajax({
				type: 'POST',
				url: domain+'/getCurrent',
				dataType: 'json',
				success: function(res){
					console.log('/getCurrent => res');
					console.dir(res);
					if(!res['s_id'] && res['s_id'] !== 0){
						console.log('songs are not ready yet');
						return;
					}else{
						if(res['y_url']){
							$('#player').hide();
							$('#y-player').show();
							y_player.loadVideoById(res['y_id'], res.now_Len, 'low');
							y_player.seekTo(res.now_Len, true);
							y_player.playVideo();
							y_player.setVolume(volume*100);
							now_song_id=res.s_id
							$('#s-id').text(res.s_id);
							$('#s-title').text(res.s_name);
							$('#s-artist').text(res.s_description.owner);
							$('#s-album').text('None');
							$('#s-length').text(res.s_t);
						}else{
							$('#player').show();
							$('#y-player').hide();
							$('#player').attr('src', res.s_url);
							$('#player')[0].currentTime = res.now_Len;
							$('#player')[0].play();
							$('#player')[0].volume = volume;
							now_song_id=res.s_id
							$('#s-id').text(res.s_id);
							$('#s-title').text(res.s_name);
							$('#s-artist').text(res.s_description.artist);
							$('#s-album').text(res.s_description.album);
							$('#s-length').text(res.s_t);
						}
					}
				},
				error: function(xhr){
					console.log(xhr);
				}
			});
			
			updateQueueList();
			
			setInterval(function(){
				$.ajax({
					type: 'POST',
					url: domain+'/getCurrent',
					dataType: 'json',
					success: function(res){
						console.log('Interval: check now len every 5sec => now_Len: '+res['now_Len'])
						if(!res['s_id'] && res['s_id'] !== 0){
							console.log('songs are not ready yet');
							return;
						}else{
							if(res['s_id'] !== now_song_id){
								window.location.reload();
							}
							if(res['y_url']){
								var y_player_t = y_player.getCurrentTime();
								if(Math.abs(y_player_t - res.now_Len) > 5){
									y_player.seekTo(res.now_Len, true);
									y_player.playVideo();
								}
							}else{
								var player_t = $('#player')[0].currentTime;
								if(Math.abs(player_t - res.now_Len) > 5){
									$('#player')[0].currentTime = res.now_Len;
									$('#player')[0].play();
								}
							}
						}
					},
					error: function(xhr){
						console.log(xhr);
					}
				});
				
				updateQueueList();
			},5000);
			$('#y-url-input').keypress(function(e){
				var code = (e.keyCode ? e.keyCode : e.which);
				if(code === 13){
					$(this).submit();
				}
			});
			$('#y-url-input').submit(y_url_add);
			$('#addicon').click(function(){
				$('#y-url-input').submit()
			});
			$('#global-pause-button').click(function(){
				$.ajax({
					type: 'POST',
					url: domain+'/GlobalPause',
					error: function(xhr){
						console.log(xhr);
					}
				})
			});
			$('#global-play-button').click(function(){
				$.ajax({
					type: 'POST',
					url: domain+'/GlobalPlay',
					error: function(xhr){
						console.log(xhr);
					}
				})
			})
		}
		function onYouTubeIframeAPIReady(){
			console.log('onYouTubeIframeAPIReady in!')
			y_player = new YT.Player('y-player', {
				height: 390,
				width: 640,
				events: {
					'onReady': onPlayerReady
				}
			});
		}
		$(document).ready(function(){
			$('#player').hide();
			$('#y-player').hide();
			
			var tag = document.createElement('script');
			tag.src = "https://www.youtube.com/iframe_api";
			var firstScriptTag = document.getElementsByTagName('script')[0];
			firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
		});
	</script>
</head>
<body>
	<div class="ts stackable grid">
		<div class="sixteen wide column ts raised segment">
			<div class="ts inverted info segment center aligned">
    			<p> 
    				If you just want to pause your browser <br />
    				Don't use Global Play/Pause <br />
    				Just close this tab until you want to listen again
    			</p>
			</div>
			<button class="ts fluid top attached button" id="global-play-button">Global Play</button>
			<div style="text-align: center;">
				<video controls preload="none" id="player"></video>
				<div id="y-player"></div>
			</div>
			<button class="ts fluid bottom attached button" id="global-pause-button">Global Pause</button>
		</div>
		<div class="twelve wide column ts raised segment">
			<div class="ts icon input">
    			<input type="text" placeholder="Please input youtube url"  id="y-url-input">
    			<i class="plus icon" id="addicon"></i>
			</div>
			<div class="ts very narrow container segment">
				Id:<div id="s-id"></div>
				Title:<div id="s-title"></div>
				Artist:<div id="s-artist"></div>
				Album:<div id="s-album"></div>
				Length:<div id="s-length"></div>
				<!-- <br /> will be append in the end-->
				<div style="text-align: center;">
					<div class="ts list selection divided" id="queue-list">
						<!--
						<div class="item queue-item">
							-- QueueId(Very Important)(same as Array's index) --SPACE-- ( -- SongId --SPACE-- Title --SPACE-- Length -- ) --
							<button class="ts icon button mini compact negative queue-item-remove">
    							<i class="icon remove"></i>
							</button>
						</div>
						-->
					</div>
				</div>
			</div>
		</div>
		<div class="four wide column ts raised segment">
			<!-- <BIG classification header> -->
			<div class="ts list selection divided" id="s-list">
				<!-- 
				<div class="item" id="s-list-item">
					<div class="header">-- Id --SPACE-- Title --</div>
					-- Length --
				</div>
				-->
			</div>
		</div>
	</div>
</body>
</html>





























